<!DOCTYPE html>
<html lang="ru" x-data="vpnPanel()" class="min-h-screen bg-slate-950 antialiased">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title x-text="data.brandTitle ? `${data.brandTitle} · VPN` : 'VPN Panel'">VPN Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    window.__PANEL_PAYLOAD__ = {{ panel_json | safe }};
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script defer src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    [x-cloak] { display: none !important; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100" x-init="refreshIcons()">
  <div class="relative min-h-screen">
    <div class="absolute inset-0">
      <img :src="data.heroImage" alt="" class="h-full w-full object-cover opacity-30" />
      <div class="absolute inset-0 bg-gradient-to-b from-slate-950 via-slate-950/90 to-slate-950"></div>
    </div>
    <div class="relative z-10">
      <div class="mx-auto max-w-5xl px-4 py-10 lg:py-14">
        <div class="mb-8 flex flex-col gap-6 rounded-3xl border border-white/10 bg-white/5 p-6 backdrop-blur">
          <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            <div>
              <p class="text-sm uppercase tracking-[0.3em] text-indigo-300">VPN панель</p>
              <h1 class="mt-2 text-3xl font-semibold text-white" x-text="data.brandTitle || 'Secure Network Access'"></h1>
              <p class="mt-2 text-sm text-slate-300">
                Скопируйте подписку или отдельные конфигурации с этой страницы. Обновите клиент, чтобы получить все доступные сервера.
              </p>
            </div>
            <div class="flex flex-col gap-3 sm:flex-row">
              <button @click="copyLink(data.subscriptionImportUrl, 'Подписка скопирована')" class="group inline-flex items-center justify-center gap-2 rounded-full bg-indigo-500 px-5 py-3 text-sm font-semibold text-white shadow-lg shadow-indigo-500/40 transition hover:bg-indigo-400">
                <i data-lucide="link" class="h-5 w-5"></i>
                Скопировать подписку
              </button>
              <a :href="data.subscriptionUrl" target="_blank" rel="noopener" class="inline-flex items-center justify-center gap-2 rounded-full border border-white/30 px-5 py-3 text-sm font-semibold text-white transition hover:border-white/60">
                <i data-lucide="globe" class="h-5 w-5"></i>
                Открыть страницу
              </a>
            </div>
          </div>
          <div class="grid gap-4 sm:grid-cols-3">
            <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
              <div class="flex items-center gap-2 text-sm uppercase tracking-wide text-slate-300">
                <i data-lucide="server" class="h-4 w-4 text-indigo-300"></i>
                Серверов
              </div>
              <p class="mt-2 text-3xl font-semibold text-white" x-text="data.meta?.serversTotal ?? 0">0</p>
              <p class="text-xs text-slate-400">Доступных конфигураций</p>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
              <div class="flex items-center gap-2 text-sm uppercase tracking-wide text-slate-300">
                <i data-lucide="alarm-clock" class="h-4 w-4 text-emerald-300"></i>
                Ближайшее продление
              </div>
              <p class="mt-2 text-3xl font-semibold text-white" x-text="formatDate(data.meta?.nextExpiry)">—</p>
              <p class="text-xs text-slate-400">Обновите подписку в клиенте, чтобы синхронизировать срок</p>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
              <div class="flex items-center gap-2 text-sm uppercase tracking-wide text-slate-300">
                <i data-lucide="wifi" class="h-4 w-4 text-cyan-300"></i>
                Статус
              </div>
              <p class="mt-2 text-3xl font-semibold" :class="data.status === 'active' ? 'text-emerald-400' : 'text-amber-300'" x-text="data.status === 'active' ? 'Активна' : 'Ожидает'">Активна</p>
              <p class="text-xs text-slate-400">Последнее обновление: <span x-text="formatDate(data.meta?.lastUpdated, true)"></span></p>
            </div>
          </div>
        </div>

        <template x-if="data.error">
          <div class="mb-6 rounded-2xl border border-amber-500/30 bg-amber-500/10 p-4 text-amber-100">
            <div class="flex items-center gap-2 text-sm font-semibold">
              <i data-lucide="alert-triangle" class="h-4 w-4"></i>
              Обратите внимание
            </div>
            <p class="mt-1 text-sm" x-text="data.error"></p>
          </div>
        </template>

        <div class="rounded-3xl border border-white/10 bg-white/5 p-6 backdrop-blur">
          <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
            <div>
              <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Конфигурации</p>
              <h2 class="text-2xl font-semibold text-white">Все доступные сервера</h2>
            </div>
            <div class="text-right text-sm text-slate-400">
              Telegram ID: <span class="font-mono text-white" x-text="data.user?.telegramId ?? '—'"></span><br>
              Пользователь: <span class="font-semibold text-white" x-text="data.user?.username ? '@' + data.user.username : '—'"></span>
            </div>
          </div>

          <div x-show="data.links && data.links.length" x-cloak class="space-y-4">
            <template x-for="item in data.links" :key="item.keyId || item.link">
              <div class="flex flex-col gap-4 rounded-2xl border border-white/10 bg-black/20 p-4 md:flex-row md:items-center md:justify-between">
                <div class="space-y-1">
                  <div class="flex items-center gap-2">
                    <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-indigo-500/20 text-indigo-200">
                      <i data-lucide="shield" class="h-5 w-5"></i>
                    </div>
                    <div>
                      <p class="text-lg font-semibold text-white" x-text="item.label || item.host"></p>
                      <p class="text-xs uppercase tracking-wider text-slate-400" x-text="`Key #${item.keyId || '—'}`"></p>
                    </div>
                  </div>
                  <p class="font-mono text-xs text-slate-300 break-all" x-text="item.link"></p>
                  <p class="text-xs text-slate-400">
                    Действует до: <span class="text-white" x-text="formatDate(item.expiresAt)"></span>
                    <span class="mx-2 text-slate-500">•</span>
                    Осталось: <span class="text-emerald-300" x-text="humanizeLeft(item.daysLeft, item.hoursLeft)"></span>
                  </p>
                </div>
                <div class="flex flex-wrap gap-2">
                  <button @click="copyLink(item.link, 'Конфигурация скопирована')" class="inline-flex items-center gap-2 rounded-full border border-white/30 px-4 py-2 text-sm font-semibold text-white transition hover:border-white/60">
                    <i data-lucide="copy" class="h-4 w-4"></i>
                    Скопировать
                  </button>
                  <button @click="showQr(item.link)" class="inline-flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm font-semibold text-white transition hover:bg-white/20">
                    <i data-lucide="qr-code" class="h-4 w-4"></i>
                    QR
                  </button>
                </div>
              </div>
            </template>
          </div>

          <div x-show="!data.links || !data.links.length" class="rounded-2xl border border-dashed border-white/20 bg-black/20 p-6 text-center text-slate-300">
            <p class="text-lg font-semibold text-white">Конфигурации пока не найдены</p>
            <p class="mt-2 text-sm">Продлите подписку в боте или обновите страницу, если ключи были выданы недавно.</p>
          </div>
        </div>

        <div class="mt-8 rounded-3xl border border-white/10 bg-gradient-to-r from-indigo-500/10 via-blue-500/10 to-cyan-500/10 p-6 text-sm text-slate-200">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
              <p class="text-base font-semibold text-white">Нужна помощь?</p>
              <p class="text-sm text-slate-300">Напишите в поддержку, указав ваш Telegram ID.</p>
            </div>
            <template x-if="data.meta?.support">
              <a :href="`https://t.me/${data.meta.support.replace('@','')}`" target="_blank" rel="noopener" class="inline-flex items-center gap-2 rounded-full bg-white/90 px-4 py-2 text-sm font-semibold text-slate-900 transition hover:bg-white">
                <i data-lucide="message-circle" class="h-4 w-4"></i>
                Написать в поддержку
              </a>
            </template>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div x-show="toastMessage" x-transition x-cloak class="fixed bottom-6 left-1/2 -translate-x-1/2 rounded-full bg-white/90 px-5 py-2 text-sm font-semibold text-slate-900 shadow-lg">
    <span x-text="toastMessage"></span>
  </div>

  <div x-show="qr.open" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4" x-transition>
    <div class="w-full max-w-sm rounded-3xl border border-white/10 bg-slate-900 p-6 text-center">
      <button class="ml-auto flex items-center justify-center rounded-full border border-white/20 p-2 text-white transition hover:bg-white/10" @click="qr.open=false">
        <i data-lucide="x" class="h-5 w-5"></i>
      </button>
      <p class="mb-3 text-sm text-slate-300">Отсканируйте код для быстрого импорта</p>
      <div id="qrCanvas" class="mx-auto w-fit rounded-2xl bg-white p-4 shadow-lg"></div>
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      if (window.lucide?.createIcons) {
        window.lucide.createIcons();
      }
    });

    function vpnPanel() {
      const data = window.__PANEL_PAYLOAD__ || {};
      return {
        data,
        toastMessage: '',
        qr: { open: false, value: '' },
        copyLink(value, message) {
          if (!value) return;
          navigator.clipboard.writeText(value).then(() => this.showToast(message));
        },
        showToast(message) {
          this.toastMessage = message;
          setTimeout(() => this.toastMessage = '', 2500);
        },
        formatDate(value, includeTime = false) {
          if (!value) return '—';
          const date = new Date(value);
          if (Number.isNaN(date)) return '—';
          return date.toLocaleString('ru-RU', {
            day: '2-digit',
            month: 'long',
            hour: includeTime ? '2-digit' : undefined,
            minute: includeTime ? '2-digit' : undefined
          });
        },
        humanizeLeft(days, hours) {
          if (days == null && hours == null) return '—';
          if ((days || 0) > 0) {
            return `${days} дн.`;
          }
          if ((hours || 0) > 0) {
            return `${hours} ч.`;
          }
          return 'менее часа';
        },
        showQr(link) {
          if (!link) return;
          this.qr.open = true;
          this.$nextTick(() => {
            const qrContainer = document.getElementById('qrCanvas');
            if (!qrContainer) return;
            qrContainer.innerHTML = '';
            window.QRCode.toCanvas(qrContainer, link, { width: 220 });
          });
        },
        refreshIcons() {
          if (window.lucide?.createIcons) {
            window.lucide.createIcons();
          }
        }
      };
    }
  </script>
</body>
</html>

